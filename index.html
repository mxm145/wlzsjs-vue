<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>“争做小小号网民”云南省青少年网络安全知识竞赛</title>
    <script src="static/flexible.js"></script>
    <script src="static/layer.js"></script>
    <script src="//res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
    <script type="text/javascript">
      var wx_tk = '';
      var $_GET = (function(){
          var url = window.document.location.href.toString();
          var u = url.split("?");
          if(typeof(u[1]) == "string"){
            u = u[1].split("&");
            var get = {};
            for(var i in u){
              var j = u[i].split("=");
              get[j[0]] = j[1];
            }
            return get;
          }else{
            return {};
          }
      })();
      var wx_tk = sessionStorage.getItem("wx_tk");
      if(wx_tk == null || wx_tk == undefined){
        sessionStorage.setItem("wx_tk", 0);
        window.location.href='/new/index.php?nova_p=QWNIMFRZbmsxZWlFd0hBa3R0SlY3SkNTa2N3aFRmVEk3TSt3THc0aXNnUT0@';
      }
      if(wx_tk == 0){
        sessionStorage.setItem("wx_tk", $_GET['wx_tk']);
        wx_tk = $_GET['wx_tk'];
      }
    </script>
    <style>
      #audio_btn {
        position: absolute;
        right: 20px;
        top: 20px;
        z-index: 200;
        width: 30px;
        height: 30px
      }
      .off {
        background-image: url(static/music.png);
        background-size: contain
      }
      .rotate {
        -webkit-animation: rotating 1.2s linear infinite;
        -moz-animation: rotating 1.2s linear infinite;
        -o-animation: rotating 1.2s linear infinite;
        animation: rotating 1.2s linear infinite
      }
      @-webkit-keyframes rotating {
        from {
          -webkit-transform: rotate(0)
        }
        to {
          -webkit-transform: rotate(360deg)
        }
      }
    </style>
  </head>
  <body>
    <div id="app"></div>
    <!-- built files will be auto injected -->
    <div id="audio_btn" onclick="toggleRotate()" class="off rotate"><audio src="static/music.mp3" loop="loop" preload="load" id="bgmusic"></audio></div>
    <script>
    function toggleRotate(){
      var audio_btn = document.querySelector('#audio_btn');
      if (audio_btn.classList.contains('rotate')) {
        audio_btn.classList.remove('rotate');
        var audio = document.getElementById('bgmusic');
        audio.pause();
      }else{
        audio_btn.classList.add('rotate');
        var audio = document.getElementById('bgmusic');
        audio.play();
      }
    }
    function AJAX(){
      var http = function (url, content, method,callback,header) {
        var http_request ;
        if (window.XMLHttpRequest) { // Mozilla, Safari,...
          http_request = new XMLHttpRequest();
          if (http_request.overrideMimeType) {
            http_request.overrideMimeType('text/xml');
          }
        } else if (window.ActiveXObject) { // IE
          try {
            http_request = new ActiveXObject("Msxml2.XMLHTTP");
          } catch (e) {
            try {
              http_request = new ActiveXObject("Microsoft.XMLHTTP");
            } catch (e) {}
          }
        }
        if (!http_request) {
          console.log('xhr实例不成功')
          return false;
        }
        //装饰方法,返回带callback的改变状态方法
        var stateChangeHandler = function(fun) {
          return function(){
             if (http_request.readyState == 4) {
              if (http_request.status == 200) {
                if (!fun) return;
                fun(http_request.responseText);
              } else {
                alert('There was a problem with the request.');
              }
            }
          }
        }
        http_request.onreadystatechange = stateChangeHandler(callback);//绑定状态改变方法
        http_request.open(method, url, true);//建立连接，定义方法，url，是否异步
        if (header) {
          for (var i in header) {
            http_request.setRequestHeader(i,header[i]);
          }
        }
        http_request.send(content);//发送内容
      }
      return {
        get:function(url,callback){
          return new http(url,"","get",callback);
        }
      }
    }
    var M = new AJAX();
    M.get('https://webapp.yunnan.cn/new/index.php?nova_p=VkNTcDRpVktaZ2FmZThqN082QTgwY09BT0NreExRRlEzRWN4V2F6ck11Yk52YjBuTHBaS0tNK0FQWWdTRkdpeA@@&ready=1&url='+encodeURIComponent(window.location.href), function(res){
      var res = JSON.parse(res);
      if (res.success == 1) {
        wx.config({
          appId: res.appid,
          timestamp: res.timestamp,
          nonceStr: res.noncestr,
          signature: res.signature,
          jsApiList: ['previewImage','onMenuShareTimeline', 'onMenuShareAppMessage', 'onMenuShareQQ', 'onMenuShareWeibo', 'onMenuShareQZone']
        });
        var shareData = {
          title: '“争做小小号网民”云南省青少年网络安全知识竞赛',
          desc: '学网络安全知识赢学习鼓励金，微信拼图小游戏等你来挑战！',
          link: 'https://webapp.yunnan.cn/new/s/2017/hy/xxhwm/',
          imgUrl: 'https://webapp.yunnan.cn/new/s/2017/hy/xxhwm/share.jpg',
          success: function(){},
          cancel: function(){}
        };
        wx.ready(function(){
          var audio = document.getElementById('bgmusic');
          audio.play();
          wx.onMenuShareTimeline(shareData);
          wx.onMenuShareAppMessage(shareData);
          wx.onMenuShareQQ(shareData);
          wx.onMenuShareWeibo(shareData);
          wx.onMenuShareQZone(shareData);
        })
      }
    });
    </script>
  </body>
</html>
